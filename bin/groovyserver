#!/bin/sh

if  [ "$1" != "-q" ]; then
  export OPT="-Dgroovyserver.verbose=true"
else
  shift
fi

if [ "x$GROOVY_HOME" = "x" ]; then
  echo "environment variable GROOVY_HOME must be set."
  exit 1;
fi

if [ "$1" = "-k" -o "$1" = "-r" ]; then
  if [ -f ~/.groovy/groovyserver/pid ]; then
    pid=`cat ~/.groovy/groovyserver/pid`
    kill $pid
    echo "kill groovy server $pid"
    rm  ~/.groovy/groovyserver/pid
  else
    echo "pid file ~/.groovy/groovyserver/pid not found"
  fi
  if [ "$1" = "-k" ]; then
    exit
  fi
  echo "restart groovy server"
  shift
fi

if [ -f ~/.groovy/groovyserver/pid ]; then
  pid=`cat ~/.groovy/groovyserver/pid`
  if ! ps -p $pid | grep $pid > /dev/null; then
    rm ~/.groovy/groovyserver/pid
  else
    echo Groovy server already running, pid is `cat ~/.groovy/groovyserver/pid`.
    echo To kill the server, run "groovyserver -k".
    echo If groovy server does not ruuning actually,
    echo retry after removing file ~/.groovy/groovyserver/pid.
    exit
  fi
fi

GROOVYSERV_HOME=`dirname $0`/..

CP=$GROOVYSERV_HOME/src/main/groovy:$GROOVYSERV_HOME/target/classes:~/.m2/repository/net/java/dev/jna/jna/3.2.2/jna-3.2.2.jar

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;; 
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
esac

if $cygwin ; then
  CP=`cygpath --path --mixed "$CP"`
fi

$GROOVY_HOME/bin/groovy -cp $CP $OPT $GROOVYSERV_HOME/src/main/groovy/org/jggug/kobo/groovyserv/GroovyServer.groovy "$@" &

pid=$!

if ps -p $pid | grep $pid > /dev/null; then
  echo $pid > ~/.groovy/groovyserver/pid
fi

echo "groovy server $pid is successfully started."

